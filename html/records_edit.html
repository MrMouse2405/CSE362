<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Record</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="min-h-screen bg-base-200">

<div class="container mx-auto p-6 max-w-2xl">

    <h1 class="text-3xl font-bold mb-6">Edit Record</h1>

    <div x-data="{
        recordId: new URLSearchParams(window.location.search).get('id'),
        record: null,
        details: '',
        loading: true,
        submitting: false,
        error: null,

        async fetchRecord() {
            if (!this.recordId) {
                this.error = 'No record ID provided';
                this.loading = false;
                return;
            }

            try {
                const response = await fetch('/api/v0/records/' + this.recordId);
                if (!response.ok) {
                    this.error = 'Record not found';
                } else {
                    this.record = await response.json();
                    this.details = this.record.details;

                    // Check if record can be edited
                    if (this.record.status !== 'draft') {
                        this.error = 'Only draft records can be edited';
                    }
                }
            } catch (e) {
                this.error = 'Failed to load record';
            } finally {
                this.loading = false;
            }
        },

        async submitForm() {
            this.submitting = true;
            this.error = null;

            try {
                const formData = new FormData();
                formData.append('details', this.details);

                const response = await fetch('/api/v0/records/' + this.recordId, {
                    method: 'PATCH',
                    body: formData
                });

                const data = await response.json();

                if (data.ok) {
                    // Redirect back to the record view
                    window.location.href = '/records_view.html?id=' + this.recordId;
                } else {
                    this.error = data.message;
                }
            } catch (e) {
                this.error = 'Failed to update record';
            } finally {
                this.submitting = false;
            }
        }
    }" x-init="fetchRecord()">

        <!-- Loading State -->
        <div x-show="loading" class="text-center py-8">
            <span class="loading loading-spinner loading-lg"></span>
        </div>

        <!-- Error State (can't edit) -->
        <div x-show="!loading && error && (!record || record.status !== 'draft')" class="text-center py-8">
            <div class="alert alert-error">
                <span x-text="error"></span>
            </div>
            <a href="/records.html" class="btn btn-primary mt-4">Back to Records</a>
        </div>

        <!-- Edit Form -->
        <div x-show="!loading && record && record.status === 'draft'">

            <!-- Error Alert -->
            <div x-show="error" class="alert alert-error mb-4">
                <span x-text="error"></span>
            </div>

            <!-- Record Title (read-only) -->
            <div class="mb-4">
                <span class="text-base-content/60">Editing:</span>
                <span class="font-bold text-lg" x-text="record.title"></span>
            </div>

            <form @submit.prevent="submitForm()" class="space-y-4">

                <!-- Details Field -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Details</span>
                    </label>
                    <textarea x-model="details"
                              class="textarea textarea-bordered w-full"
                              rows="6"
                              placeholder="Enter details"></textarea>
                </div>

                <!-- Buttons -->
                <div class="flex gap-4">
                    <button type="submit"
                            class="btn btn-primary"
                            :disabled="submitting">
                        <span x-show="submitting" class="loading loading-spinner loading-sm"></span>
                        <span x-text="submitting ? 'Saving...' : 'Save Changes'"></span>
                    </button>
                    <a :href="'/records_view.html?id=' + recordId" class="btn btn-ghost">Cancel</a>
                </div>
            </form>
        </div>
    </div>

</div>

</body>
</html>